server {
    listen 80;
    server_name 15.188.100.106;  # O localhost para testing local

    # Redirigir todo HTTP a HTTPS (opcional, pero recomendado)
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name 15.188.100.106;  # O localhost

    # Self-signed certificates (montados via volumen)
    ssl_certificate /etc/nginx/certs/selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/selfsigned.key;

    # Config básica de seguridad (sin HSTS para self-signed)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ───────── Cabeceras comunes para upstream ─────────
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # ───────── Fichero SPA (Vite) ─────────
    root /usr/share/nginx/html;
    index index.html;
    client_max_body_size 100M;

    # ───────── Health-check global ─────────
    location = /health {
        proxy_pass http://auth-service:8000;
    }

    # ───────── Micro-servicios ─────────
    location /api/auth/       { proxy_pass http://auth-service:8000; }
    location /api/items/      { proxy_pass http://catalog-service:8000; }
    location /api/categories/ { proxy_pass http://catalog-service:8000; }
    location /api/rentals/    { proxy_pass http://rentals-service:8000; }
    location /api/upload/     { proxy_pass http://upload-service:8000; }
    location /api/payments/   { proxy_pass http://payments-service:8000; }

    # Ficheros subidos
    location /uploads/        { proxy_pass http://upload-service:8000; }

    # ───────── SPA fallback ─────────
    location / {
        try_files $uri $uri/ /index.html;
    }
}